\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --logistic --ci 0.95 --reference-allele \\10.141.0.2\Kadoorie\weigan\DATASETS\risk.allele.code --pheno \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_CLEAN_Pheno.txt --pheno-name Pheno --covar \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_CLEAN_Pheno.txt --hide-covar --sex --covar-name age,region,PC1 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\singlesnp\clean_t2d_add
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --reference-allele \\10.141.0.2\Kadoorie\weigan\DATASETS\risk.allele.code --keep \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_CLEAN_Pheno.txt --freq --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\singlesnp\clean_t2d_freq
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --keep \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_CLEAN_Pheno.txt --extract \\10.141.0.2\Kadoorie\weigan\T2D_GRS\grssnps.txt --set-hh-missing --recodeA --recode-allele \\10.141.0.2\Kadoorie\weigan\DATASETS\risk.allele.code --out  \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\add_clean_grs
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --keep \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_CLEAN_Pheno.txt --extract \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\meta_clean.txt --set-hh-missing --recodeA --recode-allele \\10.141.0.2\Kadoorie\weigan\DATASETS\risk.allele.code --out  \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\add_clean


#\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --logistic --ci 0.95 --reference-allele \\10.141.0.2\Kadoorie\weigan\DATASETS\risk.allele.code --pheno \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_CLEAN_Pheno.txt --pheno-name Pheno --covar \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_CLEAN_Pheno.txt --hide-covar --sex --covar-name age,region --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\singlesnp\clean_t2d_add_nopc
#af by region
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 12 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_12 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 16 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_16 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 26 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_26 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 36 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_36 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 46 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_46 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 52 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_52 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 58 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_58 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 68 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_68 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 78 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_78 
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\DATASETS\CKB_Clean_new_id_t2d_forward --freq --within \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-clusters \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_plink_region.txt --keep-cluster-names 88 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\freq_88 


a=read.table('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/add_clean.raw',sep=' ',header=T)
names(a)[]=sapply(strsplit(names(a)[],'_',1),'[',1)
write.csv(a,'//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/add_clean.csv',row.names=F,quote=F,na='.')

\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\T2D_GRS\CKB_Clean_unrelated_t2d --logistic --ci 0.95 --reference-allele \\10.141.0.2\Kadoorie\weigan\DATASETS\risk.allele.code --pheno \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_UNRELATED_Pheno.txt --pheno-name Pheno --covar \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\CKB_UNRELATED_Pheno.txt --hide-covar --sex --covar-name age,region,PC1 --out \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\singlesnp\unrelated_t2d_add
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\T2D_GRS\CKB_Clean_unrelated_t2d --extract \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\meta_clean.txt --set-hh-missing --recodeA --recode-allele \\10.141.0.2\Kadoorie\weigan\DATASETS\risk.allele.code --out  \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\add_unrealated
\\10.141.0.2\Kadoorie\weigan\T2D_GRS\plink --bfile \\10.141.0.2\Kadoorie\weigan\T2D_GRS\CKB_Clean_unrelated_t2d --extract \\10.141.0.2\Kadoorie\weigan\T2D_GRS\grssnps.txt --set-hh-missing --recodeA --recode-allele \\10.141.0.2\Kadoorie\weigan\DATASETS\risk.allele.code --out  \\10.141.0.2\Kadoorie\weigan\T2D_REPLICATION\add_unrealated_grs
a=read.table('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/add_unrealated.raw',sep=' ',header=T)
names(a)[]=sapply(strsplit(names(a)[],'_',1),'[',1)
write.csv(a,'//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/add_unrealated.csv',row.names=F,quote=F,na='.')


#####
# GRS
#####
t2d_geno=read.table('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/add_clean_grs.raw',header=T)
names(t2d_geno)[]=sapply(strsplit(names(t2d_geno)[],'_',1),'[',1)
region=read.table('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/CKB_plink_region.txt',header=T)
names(region)=c('FID','IID','region')
raw=merge(region,t2d_geno,by=c('FID','IID'))
freq_by_region=read.table('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/freq_by_region',header=T)
weight=read.table('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/weights.txt',header=T)
regionlist=c(12,16,26,36,46,52,58,68,78,88)
impute=as.data.frame(array(NA,dim=c(93131,60)))
names(impute)[]=names(raw)
impute[,1:7]=raw[,1:7]
for (i in 1:10){
        for (j in 8:60){
                impute[impute$region==regionlist[i],j]=ifelse(is.na(raw[ raw$region==regionlist[i],j]),
                                                              freq_by_region[ freq_by_region$CLST==regionlist[i] & freq_by_region$SNP==names(raw)[j],'MAF']*2,
                                                              round(raw[ raw$region==regionlist[i],j],0))
                j=j+1
        }
        i=i+1
}
beta=c("rs340874", "rs7578597", "rs11708067", "rs1470579", "rs16861329", "rs6815464", "rs7754840", "rs4607517", "rs6467136", "rs7041847", "rs10811661", "rs1111875", "rs7901695", "rs2237892", "rs5215", "rs1552224", "rs10830963", "rs1359790", "rs7172432", "rs2028299", "rs4430796", "rs6017317", "rs13266634", "rs8042680", "rs2191349")
ir=c("rs780094", "rs3923113", "rs2943641", "rs1801282", "rs972283", "rs1531343")
impute$grst=rowSums(impute[,8:60])
impute$grsb=rowSums(impute[,beta])
impute$grsir=rowSums(impute[,ir])
summary(impute$grst)
summary(impute$grsb)
summary(impute$grsir)

raw$grst=rowSums(raw[,8:60])
raw$grsb=rowSums(raw[,beta])
raw$grsir=rowSums(raw[,ir])
summary(raw$grst)
summary(raw$grsb)
summary(raw$grsir)
raw$na=apply(raw[,8:60],1,function(x) sum(as.numeric(is.na(x))))

grs_w=function(x){
        impute_w=as.data.frame(array(NA,dim=c(93131,63)))
        names(impute_w)[]=names(impute)
        impute_w[,c(1:7,61:63)]=impute[,c(1:7,61:63)]
        for (j in 8:60){
                impute_w[,j]=  weight[weight$SNP==names(impute)[j],x]*impute[,j]
                j=j+1
                
        }
        impute_w[,paste('grst',names(weight)[x],sep='_')]=rowSums(impute_w[,8:60])
        impute_w[,paste('grsb',names(weight)[x],sep='_')]=rowSums(impute_w[,beta])
        impute_w[,paste('grsir',names(weight)[x],sep='_')]=rowSums(impute_w[,ir])
        grsw=impute_w[,c(1:2,64:66)]
        grsw
}
grs_gwas=grs_w(x=2)
grs_meta=grs_w(x=3)
grs_agen=grs_w(x=4)
grs_acc=impute[,c(1:2,61:63)]
grsc=cbind(grs_agen,grs_gwas,grs_meta,grs_acc)
grsc=grsc[,c(1:5,8:10,13:15,18:20)]


########################
# association analysis
########################
phe=read.table('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/CKB_CLEAN_Pheno.txt',header=T)
phe$T2D=ifelse(phe$Pheno==1,0,ifelse(phe$Pheno==2,1,NA))
grs=merge(phe,grsc,by=c('FID','IID'))
#quantile
grs_quantile=function(data,x,xquantile){
        data[,paste(xquantile)]=cut(data[,x],quantile(data[,x],c(0,0.25,0.5,0.75,1),na.rm=T),include.lowest=TRUE)
        levels(data[,paste(xquantile)])=c(1,2,3,4)
}
for (i in 9:20){
        grs[,paste(names(grs)[i],'q',sep='_')]=cut(grs[,i],quantile(grs[,i],c(0,0.25,0.5,0.75,1),na.rm=T),include.lowest=TRUE)
        levels(grs[,paste(names(grs)[i],'q',sep='_')])=c(1,2,3,4)
        i=i+1
}
grsglm<-function(dataset,disease){
        
        results=array(NA,dim=c(24,7))
        for (i in 9:17){
                gl<-summary(glm(dataset[,disease] ~scale(dataset[,i]) + 
                                        dataset[,'sex'] + dataset[,'age'] + 
                                        dataset[,'region'], family=binomial))
                results[i-8,]=c(names(dataset)[i],round(gl$coefficients[2,1:2],4),
                                round(exp(gl$coefficients[2,1]+0),4), 
                                round(exp(gl$coefficients[2,1]-gl$coefficients[2,2]*1.96),4),
                                round(exp(gl$coefficients[2,1]+gl$coefficients[2,2]*1.96),4),
                                gl$coefficients[2,4])
                i=i+1
        }
        for (i in 18:32){
                gl<-summary(glm(dataset[,disease] ~as.numeric(dataset[,i]) + 
                                        dataset[,'sex'] + dataset[,'age'] + 
                                        dataset[,'region'], family=binomial))
                results[i-8,]=c(names(dataset)[i],round(gl$coefficients[2,1:2],4),
                                round(exp(gl$coefficients[2,1]+0),4), 
                                round(exp(gl$coefficients[2,1]-gl$coefficients[2,2]*1.96),4),
                                round(exp(gl$coefficients[2,1]+gl$coefficients[2,2]*1.96),4),
                                gl$coefficients[2,4])
                i=i+1
        }
        results=as.data.frame(results)
        colnames(results)[]=c('GRS','Beta','Std.Error','OR','95%CI_LOW','95%CI_UP','P')
        write.csv(results,paste('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/',c(disease),'_association_nopc.csv',sep=''),row.names=F,quote=F)
}

grsglm(dataset = grs,disease = 'T2D')

grsglm_group<-function(dataset,disease){
        
        results=array(NA,dim=c(36,7))
        for (i in 21:32){
                gl<-summary(glm(dataset[,disease] ~dataset[,i] + 
                                        dataset[,'sex'] + dataset[,'age'] + 
                                        dataset[,'region'], family=binomial))
                
                results[c(3*i-62),]=c(names(dataset)[i],round(gl$coefficients[2,1:2],4),
                                      round(exp(gl$coefficients[2,1]+0),4), 
                                      round(exp(gl$coefficients[2,1]-gl$coefficients[2,2]*1.96),4),
                                      round(exp(gl$coefficients[2,1]+gl$coefficients[2,2]*1.96),4),
                                      gl$coefficients[2,4])
                results[c(3*i-61),]=c(names(dataset)[i],round(gl$coefficients[3,1:2],4),
                                      round(exp(gl$coefficients[3,1]+0),4), 
                                      round(exp(gl$coefficients[3,1]-gl$coefficients[3,2]*1.96),4),
                                      round(exp(gl$coefficients[3,1]+gl$coefficients[3,2]*1.96),4),
                                      gl$coefficients[3,4])
                results[c(3*i-60),]=c(names(dataset)[i],round(gl$coefficients[4,1:2],4),
                                      round(exp(gl$coefficients[4,1]+0),4), 
                                      round(exp(gl$coefficients[4,1]-gl$coefficients[4,2]*1.96),4),
                                      round(exp(gl$coefficients[4,1]+gl$coefficients[4,2]*1.96),4),
                                      gl$coefficients[4,4])
                i=i+1
                
        }
        results=as.data.frame(results)
        colnames(results)[]=c('GRS','Beta','Std.Error','OR','95%CI_LOW','95%CI_UP','P')
        write.csv(results,paste('//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/','Group',c(disease),'_association.csv',sep=''),row.names=F,quote=F)
}

grsglm_group(dataset = grs,disease = 'T2D')


write.csv(grsc,'//10.141.0.2/Kadoorie/weigan/T2D_REPLICATION/grs_score_clean.csv',row.names=F,quote=F,na='.')
